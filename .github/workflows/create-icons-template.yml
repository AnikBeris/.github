name: create-icons-template

on:
  workflow_dispatch:

  schedule:
    - cron: '* */12 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Generate cards — обрезка описания по словам
        run: |
          mkdir -p icons-template

          repos=(
              "Auto-Role-Channel-Bot-Discord"
              "Auto-Discord-Cleaner"
              "BotEpicGamesFreeAssets"
              "Automatic-execution-of-Discord-tasks"
              "automatic-calculation-of-HLOD-Unreal-Engine"
              "Landscape-Unreal-Engine"
              "CI-CD-Unreal-Engine-5"
              "Unreal-Engine-Docker-Pixel-Streaming"
              "UE5-zen-server-docker"
              "UE5-Achievements-Steam"
              "UE5-Epic-Games-Launcher"
              "UE5-Templates"
              "UE-Widget-Development"
              "n8n-with-VPN-3x-ui---Xray---VLESS_in_Docker"
              "n8n-docker"
              "limitation-in-the-CPU-RAM-3X-UI"
              "self-signed-certificate"
              "DuckDNS-DSM-Synology"
              "Edge-TTS-Text-to-Speech"
          )

          declare -A colors=(
            ["Unknown"]="rgba(255, 0, 0, 1)"
            ["YAML"]="rgba(251, 255, 0, 1)"
            ["YML"]="rgba(251, 255, 0, 1)"
            ["Python"]="rgba(53, 114, 165, 1)"
            ["JavaScript"]="rgba(182, 165, 34, 1)"
            ["TypeScript"]="rgba(43, 116, 137, 1)"
            ["Go"]="rgba(0, 173, 216, 1)"
            ["Rust"]="rgba(222, 165, 132, 1)"
            ["C++"]="rgba(243, 75, 125, 1)"
            ["C"]="rgba(85, 85, 85, 1)"
            ["Java"]="rgba(176, 114, 25, 1)"
            ["C#"]="rgba(23, 134, 0, 1)"
            ["PHP"]="rgba(79, 93, 149, 1)"
            ["HTML"]="rgba(227, 76, 38, 1)"
            ["CSS"]="rgba(86, 61, 124, 1)"
            ["Shell"]="rgba(137, 224, 81, 1)"
            ["Bash"]="rgba(137, 224, 81, 1)"
            ["Batchfile"]="rgba(137, 224, 81, 1)"
            ["Dockerfile"]="rgba(29, 215, 248, 1)"
            ["Ruby"]="rgba(112, 21, 22, 1)"
            ["Kotlin"]="rgba(241, 142, 51, 1)"
            ["Swift"]="rgba(255, 172, 69, 1)"
            ["R"]="rgba(25, 140, 231, 1)"
            ["Scala"]="rgba(194, 45, 64, 1)"
            ["Perl"]="rgba(2, 152, 195, 1)"
            ["Lua"]="rgba(0, 0, 128, 1)"
            ["Objective-C"]="rgba(67, 142, 255, 1)"
            ["VHDL"]="rgba(173, 178, 203, 1)"
          )


          for repo in "${repos[@]}"; do
            json=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                        "https://api.github.com/repos/AnikBeris/$repo")

            name=$(echo "$json" | jq -r '.name')
            full_desc=$(echo "$json" | jq -r '.description // "No description"')
            lang=$(echo "$json" | jq -r '.language // "Unknown"')
            stars=$(echo "$json" | jq -r '.stargazers_count')
            color=${colors[$lang]:-"#666666"}

            desc=$(echo "$full_desc" | fold -s -w 60)

            line1=$(echo "$desc" | sed -n '1p' | cut -c1-60)
            line2=$(echo "$desc" | sed -n '2p' | cut -c1-60)
            line3=$(echo "$desc" | sed -n '3p' | cut -c1-57)

            if echo "$desc" | sed -n '4p' | grep -q .; then
              line3="${line3}..."
            fi

            [ -z "$line1" ] && line1=" "
            [ -z "$line2" ] && line2=" "
            [ -z "$line3" ] && line3=" "

            # Улучшенное экранирование — добавляем экранирование для всех специальных символов
            for var in name line1 line2 line3 lang stars color; do
              printf -v "$var" '%b' "${!var//&/&amp;}"  # &
              printf -v "$var" '%b' "${!var//</&lt;}"    # <
              printf -v "$var" '%b' "${!var//>/&gt;}"    # >
              printf -v "$var" '%b' "${!var//|/\\|}"     # |
              printf -v "$var" '%b' "${!var//\\/\\\\}"   # \
              printf -v "$var" '%b' "${!var//@/\\@}"     # @
            done

            # Копируем шаблон
            cp .github/SVG-image-example/example.svg "icons-template/$repo.svg"

            # Безопасная замена с использованием временного файла
            sed -i "s@{{REPO_NAME}}@$name@g"           "icons-template/$repo.svg"
            sed -i "s@{{LINE_1}}@$line1@g"             "icons-template/$repo.svg"
            sed -i "s@{{LINE_2}}@$line2@g"             "icons-template/$repo.svg"
            sed -i "s@{{LINE_3}}@$line3@g"             "icons-template/$repo.svg"
            sed -i "s@{{LANGUAGE}}@$lang@g"            "icons-template/$repo.svg"
            sed -i "s@{{STARS}}@$stars@g"              "icons-template/$repo.svg"
            sed -i "s@{{LANG_COLOR}}@$color@g"         "icons-template/$repo.svg"
          done

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add icons-template/
          git diff --staged --quiet || (git commit -m "Updating repository card icons based on template" && git push)
