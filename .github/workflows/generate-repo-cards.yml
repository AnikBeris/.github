name: Generate Repo Cards

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # каждые 24 часа

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create cards directory
        run: mkdir -p .github/profile/cards

      - name: Generate repo cards
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
        run: |
          REPOS=(
            "Auto-Role-Channel-Bot-Discord"
            "UE-Widget-Development"
          )

          for REPO in "${REPOS[@]}"; do
            DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                      "https://api.github.com/repos/$GITHUB_OWNER/$REPO")

            NAME=$(echo "$DATA" | jq -r '.name')
            DESCRIPTION=$(echo "$DATA" | jq -r '.description // ""')
            LANGUAGE=$(echo "$DATA" | jq -r '.language // "Unknown"')
            STARS=$(echo "$DATA" | jq -r '.stargazers_count')

            if [ -z "$DESCRIPTION" ] || [ "$DESCRIPTION" = "null" ]; then
              DESCRIPTION="No description"
            fi

            case "$LANGUAGE" in
              "JavaScript") LANG_COLOR="#f1e05a" ;;
              "C++") LANG_COLOR="#f34b7d" ;;
              "C#") LANG_COLOR="#178600" ;;
              "Python") LANG_COLOR="#3572A5" ;;
              "Unknown") LANG_COLOR="#666666" ;;
              *) LANG_COLOR="#ffffff" ;;
            esac

            OUTPUT=".github/profile/cards/${REPO}.svg"

            cat > "$OUTPUT" <<EOF
<svg width="400" height="140" viewBox="0 0 400 140" xmlns="http://www.w3.org/2000/svg" style="border-radius:12px">
  <rect width="400" height="140" fill="#0f0f0f" rx="12"/>
  <text x="20" y="35" fill="#58a6ff" font-family="Segoe UI, sans-serif" font-size="20" font-weight="600">${NAME}</text>
  <text x="20" y="65" fill="#8b949e" font-family="Segoe UI, sans-serif" font-size="14">${DESCRIPTION}</text>
  <circle cx="25" cy="100" r="8" fill="${LANG_COLOR}"/>
  <text x="40" y="105" fill="#ffffff" font-family="Segoe UI, sans-serif" font-size="14">${LANGUAGE}</text>
  <text x="320" y="105" fill="#8b949e" font-family="Segoe UI, sans-serif" font-size="14" text-anchor="end">${STARS}</text>
  <text x="305" y="105" fill="#8b949e" font-family="Segoe UI, sans-serif" font-size="14" text-anchor="end">⭐</text>
</svg>
EOF

            echo "Generated: $OUTPUT"
          done

      - name: Commit & Push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add .github/profile/cards/

          if ! git diff --quiet --cached; then
            git commit -m "Update repo cards [auto]"
            git push
          else
            echo "No changes. Skipping commit."
          fi
