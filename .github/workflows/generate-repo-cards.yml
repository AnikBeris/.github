name: Update Repo Cards from Template

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */12 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Generate cards — правильная обрезка по словам и с ...
        run: |
          mkdir -p .github/profile/cards

          repos=(
            "Auto-Role-Channel-Bot-Discord"
            "UE-Widget-Development"
            # добавляй свои
          )

          declare -A colors=(
            ["Python"]="#3572A5" ["JavaScript"]="#f1e05a" ["TypeScript"]="#2b7489"
            ["Go"]="#00ADD8" ["Rust"]="#dea584" ["C++"]="#f34b7d" ["HTML"]="#e34c26"
          )

          for repo in "${repos[@]}"; do
            json=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                        "https://api.github.com/repos/AnikBeris/$repo")

            name=$(echo "$json" | jq -r '.name')
            full_desc=$(echo "$json" | jq -r '.description // "No description"')
            lang=$(echo "$json" | jq -r '.language // "Unknown"')
            stars=$(echo "$json" | jq -r '.stargazers_count')
            color=${colors[$lang]:-"#666666"}

            # ──────── УМНАЯ ОБРЕЗКА ОПИСАНИЯ ────────
            # Максимум 60 символов в строке, перенос по словам, 3 строки, в конце ...
            desc=$(echo "$full_desc" | fold -s -w 60)  # -s = разбивает только по пробелам

            line1=$(echo "$desc" | sed -n '1p' | cut -c1-60)
            line2=$(echo "$desc" | sed -n '2p' | cut -c1-60)
            line3=$(echo "$desc" | sed -n '3p' | cut -c1-57)  # 57, чтобы влезли ...

            # Если есть 4-я строка — значит текст обрезан → добавляем ...
            if echo "$desc" | sed -n '4p' | grep -q .; then
              line3="${line3}..."
            fi

            # Если строк меньше 3 — заполняем неразрывными пробелами
            [ -z "$line1" ] && line1=" "
            [ -z "$line2" ] && line2=" "
            [ -z "$line3" ] && line3=" "

            # Экранируем только опасные символы
            for var in line1 line2 line3; do
              printf -v "$var" '%b' "${!var//&/&amp;}"
              printf -v "$var" '%b' "${!var//</&lt;}"
              printf -v "$var" '%b' "${!var//>/&gt;}"
            done

            # Копируем и заменяем
            cp .github/profile/template-repo-card.svg ".github/profile/cards/$repo.svg"

            sed -i "s|{{REPO_NAME}}|$name|g"               ".github/profile/cards/$repo.svg"
            sed -i "s|{{LINE_1}}|$line1|g"                 ".github/profile/cards/$repo.svg"
            sed -i "s|{{LINE_2}}|$line2|g"                 ".github/profile/cards/$repo.svg"
            sed -i "s|{{LINE_3}}|$line3|g"                 ".github/profile/cards/$repo.svg"
            sed -i "s|{{LANGUAGE}}|$lang|g"                ".github/profile/cards/$repo.svg"
            sed -i "s|{{STARS}}|$stars|g"                  ".github/profile/cards/$repo.svg"
            sed -i "s|{{LANG_COLOR}}|$color|g"            ".github/profile/cards/$repo.svg"
          done

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .github/profile/cards/
          git diff --staged --quiet || (git commit -m "Update repo cards from template" && git push)